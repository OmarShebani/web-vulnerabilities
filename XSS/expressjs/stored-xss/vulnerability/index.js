const express = require('express');
const fs = require('fs');
const app = express();

app.use(express.urlencoded({ extended: true }));

const filePath = 'comments.csv';

function readFile() {
  const data = fs.readFileSync(filePath, 'utf8');
  return data.split('\n').forEach(row => {
                                row.split('&');
                              });
}

function storeComment(author, comment) {
  const row = `${author.replace('/&/g', '&amp')}&${comment.replace('/&/g', '&amp')}\n`;

  fs.appendFileSync(filePath, row);
  console.log('Comment stored successfully.');
}

app.get(['/', '/comments'], function (req, res) {
  const comments = readFile();

  const htmlResponse = `<div id="comments-section"></div> <br>
                      <h2>Comments:</h2> <br>
                      <script>
                          const parentElement = document.getElementById('comments-section');
                          const comments = ${comments};
                          if (comments) {
                            comments.forEach(row => {
                              parentElement.insertAdjacentHTML('beforeend', \`<h4>Author: \${row[0]}</h4> <br>\`);
                              parentElement.insertAdjacentHTML('beforeend', \`<p>\${row[1]}<p> <br><br>\`);
                            )}
                          }
                      </script>
                      <h3>Post A Comment Here:</h3> <br>
                      <form action="/post-comment" method="POST">
                          <input required="" type="text" name="comment" placeholder="Type Your Comment Here..."> <br><br>
                          <input required="" type="text" name="author" placeholder="Type Your Username Here..."> <br><br>
                          <button type="submit">Post Comment</button>
                      </form>`;         
  res.send(htmlResponse);
});

app.post('/post-comment', function (req, res) {
  storeComment(req.body.author, req.body.comment);
  res.redirect('/comments');
});

app.listen(3000, function () {
  console.log('Server is running on http://localhost:3000');
});