<!DOCTYPE html>
<html lang="en">
<head>
    <title>Comments Section</title>
</head>
<body>
    <h2>Your Email Address:</h2>

    <?php
    $filePath = "email.txt";

    function getEmail() {
        global $filePath;
        try {
            $email = file_get_contents($filePath);
            if (isset($email)) {
                return $email;
            } else {
                throw new Exception("Could not get the email.");
            }

        } catch (Exception $e) {
            return NULL;
            echo "Error: " . $e->getMessage();
        }
    }

    function changeEmail($email) {
        global $filePath;
        try {
            $email = str_replace('&', '%26', $email);
            file_put_contents($filePath, $email);

        } catch (Exception $e) {
            echo "Error: " . $e->getMessage();
        }
    }

    if ($_SERVER['REQUEST_METHOD'] === 'GET' && $_SERVER['REQUEST_URI'] === '/') {
        $email = getEmail();
        if (isset($email)) {
            echo str_replace('%26', '&', "<h4>{$email}</h4>");
            ?>

            <h3>Change your email here:</h3>
            <form action="/change-email" method="POST">
                <input type="email" name="email" placeholder="New Email Address" required>
                <button type="submit">Confirm</button>
            </form>
        
            <?php
        } else {
            http_response_code(500);
            echo "Internal Server Error";
        }

    } elseif ($_SERVER['REQUEST_METHOD'] === 'POST' && $_SERVER['REQUEST_URI'] === '/change-email' && isset($_POST['email'])) {
        $email = $_POST['email'];
        
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            http_response_code(422);
            echo "The email address provided is not valid";

        } else {
            changeEmail($email);
            header("Location: /");
        }
    }
    ?>
</body>
</html>